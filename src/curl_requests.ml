open Yojson.Basic
open Yojson.Basic.Util

let config = from_file "config"

let token = member "token" config |> to_string

let bot_id = member "bot_id" config |> to_string


let members channel=
  let args_channel = [ "-F"; "token=" ^ token; "-F"; "channel=" ^ channel ] in
  ( match
      Curly.(
        run ~args:args_channel
          (Request.make ~url:"https://slack.com/api/conversations.members"
             ~meth:`POST ()))
    with
  | Ok x ->
      List.map to_string
        ( from_string x.Curly.Response.body
        |> Util.member "members" |> Util.to_list )
  | _ -> failwith "There's an error" )
  |> List.filter (fun id ->
         id <> bot_id && id <> "U0J5U03J4" (*avsm*) && id <> "U0JP4EH7H" (*samoht*) && id <> "U0JCSR1HT" (*magnus*) && id <> "UEQMNGNH0" (* pascutto*))

let write_to_slack channel output=
let args_message =
    [
      "-F";
      "token=" ^ token;
      "-F";
      "channel=" ^ channel;
      "-F";
      "text=" ^ output;
    ]
  in
    Curly.(
      run ~args:args_message
        (Request.make ~url:"https://slack.com/api/chat.postMessage" ~meth:`POST
           ()))